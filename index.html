<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Automate Flow Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border-left: 5px solid;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .stat-card.success { border-left-color: #10b981; }
        .stat-card.warning { border-left-color: #f59e0b; }
        .stat-card.error { border-left-color: #ef4444; }
        .stat-card.info { border-left-color: #3b82f6; }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card.success .stat-number { color: #10b981; }
        .stat-card.warning .stat-number { color: #f59e0b; }
        .stat-card.error .stat-number { color: #ef4444; }
        .stat-card.info .stat-number { color: #3b82f6; }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e5e7eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .flows-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .section-header {
            background: #f8fafc;
            padding: 20px 25px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1f2937;
        }

        .last-updated {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .flows-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .flow-item {
            padding: 20px 25px;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.3s ease;
        }

        .flow-item:hover {
            background: #fafbfc;
        }

        .flow-item:last-child {
            border-bottom: none;
        }

        .flow-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .flow-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .flow-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-enabled { background: #d1fae5; color: #065f46; }
        .status-suspended { background: #fef3c7; color: #92400e; }
        .status-stopped { background: #fee2e2; color: #991b1b; }
        
        .run-status-succeeded { background: #d1fae5; color: #065f46; }
        .run-status-failed { background: #fee2e2; color: #991b1b; }
        .run-status-running { background: #dbeafe; color: #1e40af; }
        .run-status-cancelled { background: #f3f4f6; color: #4b5563; }

        .flow-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            color: #6b7280;
            font-size: 0.85rem;
        }

        .flow-metric {
            display: flex;
            flex-direction: column;
        }

        .metric-label {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .metric-value {
            font-size: 0.9rem;
            color: #374151;
        }

        .error-message {
            color: #ef4444;
            font-size: 0.8rem;
            margin-top: 5px;
            font-style: italic;
        }

        .alert-banner {
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none;
            border-left: 5px solid;
        }

        .alert-banner.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .alert-banner.success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-left-color: #10b981;
            color: #065f46;
        }

        .alert-banner.error {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border-left-color: #ef4444;
            color: #991b1b;
        }

        .alert-banner.warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-left-color: #f59e0b;
            color: #92400e;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4a90e2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .config-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .config-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 5px;
        }

        .form-input {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            margin-left: auto;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-indicator.connected {
            background: #10b981;
        }

        @media (max-width: 768px) {
            .config-row {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Power Automate Monitor</h1>
            <p>Real-time monitoring and alerting for your Microsoft Power Automate flows</p>
        </div>

        <div class="main-content">
            <div class="config-panel">
                <h3 style="margin-bottom: 20px; color: #1f2937;">Configuration</h3>
                <div class="config-row">
                    <div class="form-group">
                        <label class="form-label">Environment URL</label>
                        <input type="text" class="form-input" id="environmentUrl" placeholder="https://yourtenant.crm.dynamics.com/">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Refresh Interval (seconds)</label>
                        <input type="number" class="form-input" id="refreshInterval" value="30" min="10" max="300">
                    </div>
                </div>
                <div class="config-row">
                    <div class="form-group">
                        <label class="form-label">Client ID</label>
                        <input type="text" class="form-input" id="clientId" placeholder="Your Azure AD App Client ID">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tenant ID</label>
                        <input type="text" class="form-input" id="tenantId" placeholder="Your Azure AD Tenant ID">
                    </div>
                </div>
            </div>

            <div class="alert-banner" id="alertBanner">
                <strong id="alertIcon">ℹ️</strong> <span id="alertMessage"></span>
            </div>

            <div class="stats-grid">
                <div class="stat-card success">
                    <div class="stat-number" id="enabledCount">-</div>
                    <div class="stat-label">Enabled Flows</div>
                </div>
                <div class="stat-card error">
                    <div class="stat-number" id="suspendedCount">-</div>
                    <div class="stat-label">Suspended Flows</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-number" id="failedRunsCount">-</div>
                    <div class="stat-label">Recent Failures</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-number" id="totalFlows">-</div>
                    <div class="stat-label">Total Flows</div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="connectBtn">🔌 Connect to Power Platform</button>
                <button class="btn btn-secondary" id="refreshBtn" disabled>🔄 Refresh Data</button>
                <button class="btn btn-secondary" id="exportBtn" disabled>📊 Export Report</button>
                <input type="text" class="search-box" id="searchBox" placeholder="🔍 Search flows by name..." disabled>
                <div class="connection-status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="connectionStatus">Disconnected</span>
                </div>
            </div>

            <div class="flows-section">
                <div class="section-header">
                    <div class="section-title">Flow Status Monitor</div>
                    <div class="last-updated" id="lastUpdated">Never updated</div>
                </div>
                <div class="flows-list" id="flowsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Click "Connect to Power Platform" to start monitoring your flows</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class PowerAutomateMonitor {
            constructor() {
                this.flows = [];
                this.filteredFlows = [];
                this.isConnected = false;
                this.refreshTimer = null;
                this.accessToken = null;
                this.environment = null;
                this.config = {
                    environmentUrl: '',
                    clientId: '',
                    tenantId: '',
                    refreshInterval: 30
                };
                
                this.initializeEventListeners();
                this.loadConfiguration();
            }

            initializeEventListeners() {
                const elements = {
                    connectBtn: document.getElementById('connectBtn'),
                    refreshBtn: document.getElementById('refreshBtn'),
                    exportBtn: document.getElementById('exportBtn'),
                    searchBox: document.getElementById('searchBox'),
                    environmentUrl: document.getElementById('environmentUrl'),
                    clientId: document.getElementById('clientId'),
                    tenantId: document.getElementById('tenantId'),
                    refreshInterval: document.getElementById('refreshInterval')
                };

                elements.connectBtn.addEventListener('click', () => this.handleConnect());
                elements.refreshBtn.addEventListener('click', () => this.refreshData());
                elements.exportBtn.addEventListener('click', () => this.exportReport());
                elements.searchBox.addEventListener('input', (e) => this.filterFlows(e.target.value));
                
                // Configuration change listeners
                Object.keys(this.config).forEach(key => {
                    const element = elements[key];
                    if (element) {
                        element.addEventListener('change', () => this.updateConfiguration());
                    }
                });
            }

            loadConfiguration() {
                // Load from URL parameters or local configuration
                const urlParams = new URLSearchParams(window.location.search);
                
                Object.keys(this.config).forEach(key => {
                    const urlValue = urlParams.get(key);
                    const element = document.getElementById(key);
                    
                    if (urlValue && element) {
                        element.value = urlValue;
                        this.config[key] = urlValue;
                    } else if (element) {
                        this.config[key] = element.value;
                    }
                });
            }

            updateConfiguration() {
                this.config = {
                    environmentUrl: document.getElementById('environmentUrl').value.trim(),
                    clientId: document.getElementById('clientId').value.trim(),
                    tenantId: document.getElementById('tenantId').value.trim(),
                    refreshInterval: parseInt(document.getElementById('refreshInterval').value) || 30
                };

                // Restart auto-refresh with new interval if connected
                if (this.isConnected) {
                    this.startAutoRefresh();
                }
            }

            validateConfiguration() {
                const { environmentUrl, clientId, tenantId } = this.config;
                
                if (!environmentUrl || !clientId || !tenantId) {
                    throw new Error('Please fill in all required configuration fields');
                }

                try {
                    new URL(environmentUrl);
                } catch {
                    throw new Error('Invalid environment URL format');
                }

                // Basic GUID format validation for Azure AD IDs
                const guidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                if (!guidPattern.test(clientId) || !guidPattern.test(tenantId)) {
                    throw new Error('Client ID and Tenant ID must be valid GUIDs');
                }
            }

            async handleConnect() {
                try {
                    this.validateConfiguration();
                    await this.authenticate();
                    await this.fetchFlows();
                    this.setConnectedState(true);
                    this.showAlert('Successfully connected to Power Platform! Monitoring active flows.', 'success');
                    this.startAutoRefresh();
                } catch (error) {
                    this.setConnectedState(false);
                    this.showAlert(`Connection failed: ${error.message}`, 'error');
                    console.error('Connection error:', error);
                }
            }

            async authenticate() {
                const { clientId, tenantId } = this.config;
                
                // Using Microsoft Authentication Library (MSAL) approach
                // In a real implementation, you would use MSAL.js library
                const authUrl = `https://login.microsoftonline.com/${tenantId}/oauth2/v2.0/authorize`;
                const redirectUri = encodeURIComponent(window.location.origin);
                const scope = encodeURIComponent('https://service.powerapps.com//.default');
                
                // For this demo, we'll simulate the authentication process
                // In production, implement proper OAuth 2.0 flow with MSAL.js
                this.showAlert('Authentication would redirect to Microsoft login...', 'warning');
                
                // Simulate token for demonstration
                await this.delay(1000);
                this.accessToken = 'simulated-access-token';
            }

            async fetchFlows() {
                if (!this.accessToken) {
                    throw new Error('No valid access token available');
                }

                const { environmentUrl } = this.config;
                
                try {
                    this.showLoading();
                    
                    // Construct the API endpoint for Power Automate flows
                    const apiEndpoint = `${environmentUrl}/api/data/v9.0/workflows`;
                    const queryParams = new URLSearchParams({
                        '$select': 'workflowid,name,statecode,statuscode,createdon,modifiedon,category',
                        '$filter': "category eq 5", // Category 5 = Modern Flow
                        '$orderby': 'modifiedon desc',
                        '$top': '100'
                    });

                    // In a real implementation, make the actual API call
                    // const response = await this.makeApiCall(`${apiEndpoint}?${queryParams}`);
                    
                    // For demonstration, simulate API response
                    await this.delay(1500);
                    const simulatedFlows = this.generateRealisticFlowData();
                    
                    this.flows = simulatedFlows;
                    this.filteredFlows = [...this.flows];
                    this.updateStats();
                    this.renderFlows();
                    this.updateLastUpdated();
                    
                    // Fetch run history for each flow
                    await this.fetchFlowRunHistory();
                    
                } catch (error) {
                    throw new Error(`Failed to fetch flows: ${error.message}`);
                }
            }

            async fetchFlowRunHistory() {
                // Fetch recent run history for each flow to determine health status
                const promises = this.flows.slice(0, 10).map(async (flow) => {
                    try {
                        // In production: GET /api/data/v9.0/workflowlogs
                        await this.delay(200); // Simulate API call
                        
                        // Simulate run history data
                        const runHistory = this.generateFlowRunHistory(flow.workflowid);
                        flow.runHistory = runHistory;
                        flow.lastRunStatus = runHistory[0]?.status || 'Unknown';
                        flow.lastRunTime = runHistory[0]?.completedOn || flow.modifiedon;
                        flow.failureRate = this.calculateFailureRate(runHistory);
                        
                    } catch (error) {
                        console.warn(`Failed to fetch run history for ${flow.name}:`, error);
                        flow.lastRunStatus = 'Unknown';
                        flow.failureRate = 0;
                    }
                });

                await Promise.all(promises);
                this.updateStats();
                this.renderFlows();
            }

            generateRealisticFlowData() {
                const flowTemplates = [
                    { name: 'Daily Sales Report Automation', category: 'Business Process' },
                    { name: 'Customer Onboarding Workflow', category: 'HR & Onboarding' },
                    { name: 'Invoice Processing Pipeline', category: 'Finance & Accounting' },
                    { name: 'Email Marketing Campaign Trigger', category: 'Marketing' },
                    { name: 'IT Ticket Assignment Handler', category: 'IT Operations' },
                    { name: 'Contract Approval Workflow', category: 'Legal & Compliance' },
                    { name: 'Inventory Stock Level Alerts', category: 'Supply Chain' },
                    { name: 'Employee Leave Request Handler', category: 'HR & Onboarding' },
                    { name: 'Social Media Content Scheduler', category: 'Marketing' },
                    { name: 'Data Backup Validation Process', category: 'IT Operations' }
                ];

                return flowTemplates.map((template, index) => ({
                    workflowid: `flow-${String(index + 1).padStart(3, '0')}`,
                    name: template.name,
                    category: template.category,
                    statecode: Math.random() > 0.1 ? 1 : 0, // 90% enabled
                    statuscode: Math.random() > 0.05 ? 1 : 2, // 95% active
                    createdon: new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000).toISOString(),
                    modifiedon: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
                    runHistory: [],
                    lastRunStatus: 'Unknown',
                    lastRunTime: null,
                    failureRate: 0
                }));
            }

            generateFlowRunHistory(flowId) {
                const statuses = ['Succeeded', 'Failed', 'Running', 'Cancelled'];
                const history = [];
                const numRuns = Math.floor(Math.random() * 20) + 5;

                for (let i = 0; i < numRuns; i++) {
                    const startTime = new Date(Date.now() - (i * 2 * 60 * 60 * 1000));
                    const endTime = new Date(startTime.getTime() + Math.random() * 300000); // 0-5 minutes duration
                    
                    // Higher probability of success for realistic data
                    let status;
                    const rand = Math.random();
                    if (rand < 0.85) status = 'Succeeded';
                    else if (rand < 0.95) status = 'Failed';
                    else if (rand < 0.98) status = 'Cancelled';
                    else status = 'Running';

                    history.push({
                        runId: `${flowId}-run-${i + 1}`,
                        status,
                        startedOn: startTime.toISOString(),
                        completedOn: status === 'Running' ? null : endTime.toISOString(),
                        duration: status === 'Running' ? null : Math.floor((endTime - startTime) / 1000),
                        error: status === 'Failed' ? this.generateRandomError() : null
                    });
                }

                return history.sort((a, b) => new Date(b.startedOn) - new Date(a.startedOn));
            }

            generateRandomError() {
                const errors = [
                    'Connection timeout to SharePoint service',
                    'Microsoft Graph API rate limit exceeded',
                    'Invalid authentication token',
                    'Required field validation failed',
                    'External service temporarily unavailable',
                    'Insufficient permissions to access resource',
                    'Data conversion error in connector'
                ];
                return errors[Math.floor(Math.random() * errors.length)];
            }

            calculateFailureRate(runHistory) {
                if (!runHistory || runHistory.length === 0) return 0;
                const failedRuns = runHistory.filter(run => run.status === 'Failed').length;
                return Math.round((failedRuns / runHistory.length) * 100);
            }

            async makeApiCall(url, options = {}) {
                const defaultOptions = {
                    headers: {
                        'Authorization': `Bearer ${this.accessToken}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                };

                const response = await fetch(url, { ...defaultOptions, ...options });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`API call failed: ${response.status} ${error}`);
                }

                return response.json();
            }

            setConnectedState(connected) {
                this.isConnected = connected;
                const connectBtn = document.getElementById('connectBtn');
                const refreshBtn = document.getElementById('refreshBtn');
                const exportBtn = document.getElementById('exportBtn');
                const searchBox = document.getElementById('searchBox');
                const statusIndicator = document.getElementById('statusIndicator');
                const connectionStatus = document.getElementById('connectionStatus');

                if (connected) {
                    connectBtn.textContent = '✅ Connected';
                    connectBtn.className = 'btn btn-success';
                    connectBtn.disabled = false;
                    refreshBtn.disabled = false;
                    exportBtn.disabled = false;
                    searchBox.disabled = false;
                    statusIndicator.classList.add('connected');
                    connectionStatus.textContent = 'Connected';
                } else {
                    connectBtn.textContent = '🔌 Connect to Power Platform';
                    connectBtn.className = 'btn btn-primary';
                    connectBtn.disabled = false;
                    refreshBtn.disabled = true;
                    exportBtn.disabled = true;
                    searchBox.disabled = true;
                    statusIndicator.classList.remove('connected');
                    connectionStatus.textContent = 'Disconnected';
                    
                    if (this.refreshTimer) {
                        clearInterval(this.refreshTimer);
                        this.refreshTimer = null;
                    }
                }
            }

            async refreshData() {
                if (!this.isConnected) {
                    this.showAlert('Please connect to Power Platform first.', 'warning');
                    return;
                }

                try {
                    await this.fetchFlows();
                    this.showAlert('Data refreshed successfully!', 'success');
                } catch (error) {
                    this.showAlert(`Refresh failed: ${error.message}`, 'error');
                    console.error('Refresh error:', error);
                }
            }

            startAutoRefresh() {
                if (this.refreshTimer) {
                    clearInterval(this.refreshTimer);
                }

                const interval = this.config.refreshInterval * 1000;
                this.refreshTimer = setInterval(() => {
                    this.refreshData();
                }, interval);
            }

            updateStats() {
                const stats = this.flows.reduce((acc, flow) => {
                    acc.total++;
                    
                    if (flow.statecode === 1) acc.enabled++;
                    else acc.suspended++;
                    
                    if (flow.runHistory) {
                        const recentFails = flow.runHistory
                            .slice(