<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Automate Flow Status Dashboard</title>
    <style>
        :root {
            --primary-color: #0078d4;
            --success-color: #107c10;
            --error-color: #d83b01;
            --warning-color: #ffb900;
            --background-color: #f3f2f1;
            --card-background: #ffffff;
            --text-primary: #323130;
            --text-secondary: #605e5c;
            --border-color: #edebe9;
            --shadow: 0 1.6px 3.6px 0 rgba(0,0,0,.13), 0 0.3px 0.9px 0 rgba(0,0,0,.11);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--card-background);
            box-shadow: var(--shadow);
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #0078d4 0%, #40e0d0 100%);
            border-radius: 6px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-email {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #106ebe;
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .filters {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
        }

        .stat-card.success {
            border-left-color: var(--success-color);
        }

        .stat-card.error {
            border-left-color: var(--error-color);
        }

        .stat-card.warning {
            border-left-color: var(--warning-color);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .flows-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .flow-card {
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .flow-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 3.2px 7.2px 0 rgba(0,0,0,.13), 0 0.6px 1.8px 0 rgba(0,0,0,.11);
        }

        .flow-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .flow-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .flow-id {
            font-size: 11px;
            color: var(--text-secondary);
            font-family: 'Courier New', monospace;
        }

        .flow-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-running {
            background-color: #e7f3ff;
            color: var(--primary-color);
        }

        .status-stopped {
            background-color: #fef2e7;
            color: var(--warning-color);
        }

        .status-suspended {
            background-color: #fde7e9;
            color: var(--error-color);
        }

        .flow-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .flow-detail {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .detail-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .detail-value {
            font-size: 14px;
            color: var(--text-primary);
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: var(--text-secondary);
        }

        .error-message {
            background-color: #fde7e9;
            color: var(--error-color);
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }

        .login-card {
            background-color: var(--card-background);
            padding: 40px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            max-width: 400px;
            width: 100%;
        }

        .login-title {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .flows-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="logo" style="width: 64px; height: 64px; margin: 0 auto 20px;"></div>
            <h2 class="login-title">Power Automate Dashboard</h2>
            <p class="login-subtitle">Sign in to view your flows</p>
            <button id="loginButton" class="btn btn-primary" style="width: 100%;">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M8 1.5C4.41 1.5 1.5 4.41 1.5 8c0 3.59 2.91 6.5 6.5 6.5 3.59 0 6.5-2.91 6.5-6.5 0-3.59-2.91-6.5-6.5-6.5zm0 2c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zm0 9.5c-1.66 0-3.13-.88-3.97-2.19.03-1.3 2.61-2.01 3.97-2.01 1.35 0 3.94.71 3.97 2.01-.84 1.31-2.31 2.19-3.97 2.19z" fill="currentColor"/>
                </svg>
                Sign in with Microsoft
            </button>
            <button id="testConfigButton" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">
                Test Configuration
            </button>
            <div id="configStatus" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none; font-size: 12px; text-align: left;"></div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="hidden">
        <header>
            <div class="header-content">
                <h1>
                    <div class="logo"></div>
                    Power Automate Flow Monitor
                </h1>
                <div class="user-info">
                    <span class="user-email" id="userEmail"></span>
                    <button id="refreshButton" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M13.65 2.35c-1.8-1.8-4.7-1.8-6.5 0L5.5 4H8v1H3.5V.5h1V3l1.65-1.65c2.2-2.2 5.8-2.2 8 0s2.2 5.8 0 8c-1.1 1.1-2.55 1.65-4 1.65V10c1.05 0 2.1-.4 2.9-1.2 1.6-1.6 1.6-4.2 0-5.8z" fill="currentColor"/>
                        </svg>
                        Refresh
                    </button>
                    <button id="logoutButton" class="btn btn-secondary">Sign Out</button>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label class="filter-label">Search</label>
                    <input type="text" id="searchInput" class="filter-input" placeholder="Search flows...">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select id="statusFilter" class="filter-input">
                        <option value="">All Status</option>
                        <option value="Running">Running</option>
                        <option value="Stopped">Stopped</option>
                        <option value="Suspended">Suspended</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Environment</label>
                    <input type="text" id="environmentId" class="filter-input" value="Default-30b2cab5-4b41-42ba-9ae3-af22c87241d9" readonly>
                </div>
            </div>

            <!-- Statistics -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalFlows">0</div>
                    <div class="stat-label">Total Flows</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="runningFlows">0</div>
                    <div class="stat-label">Running</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="stoppedFlows">0</div>
                    <div class="stat-label">Stopped</div>
                </div>
                <div class="stat-card error">
                    <div class="stat-value" id="suspendedFlows">0</div>
                    <div class="stat-label">Suspended</div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading hidden">
                <div class="spinner"></div>
                <div class="loading-text">Loading flows...</div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="error-message hidden">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M10 2C5.59 2 2 5.59 2 10s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm1 13H9v-2h2v2zm0-4H9V5h2v6z" fill="currentColor"/>
                </svg>
                <span id="errorMessage"></span>
            </div>

            <!-- Flows Grid -->
            <div id="flowsGrid" class="flows-grid"></div>
        </div>
    </div>

    <!-- MSAL.js library with multiple fallbacks -->
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
    
    <script>
        // Multiple CDN fallback loader for MSAL
        const msalSources = [
            'https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js',
            'https://unpkg.com/@azure/msal-browser@2.38.0/lib/msal-browser.min.js',
            'https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.0/lib/msal-browser.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/microsoft-authentication-library-js/2.38.0/msal-browser.min.js'
        ];
        
        let sourceIndex = 0;
        
        function loadMSALFallback() {
            if (sourceIndex >= msalSources.length) {
                console.error('Failed to load MSAL from all sources');
                document.getElementById('configStatus').style.display = 'block';
                document.getElementById('configStatus').style.backgroundColor = '#fde7e9';
                document.getElementById('configStatus').style.color = '#d83b01';
                document.getElementById('configStatus').innerHTML = 
                    '<strong>Critical Error:</strong> Unable to load authentication library.<br>' +
                    'Please check your network connection and firewall settings.<br>' +
                    'The Microsoft Authentication Library (MSAL) is required for this application.';
                return;
            }
            
            console.log('Attempting to load MSAL from:', msalSources[sourceIndex]);
            const script = document.createElement('script');
            script.src = msalSources[sourceIndex];
            script.onload = function() {
                console.log('MSAL loaded successfully from:', msalSources[sourceIndex]);
                // Restart initialization after successful load
                if (typeof initializeApp === 'function') {
                    setTimeout(initializeApp, 100);
                }
            };
            script.onerror = function() {
                console.error('Failed to load from:', msalSources[sourceIndex]);
                sourceIndex++;
                loadMSALFallback(); // Try next source
            };
            document.head.appendChild(script);
        }
        
        // Check if MSAL loaded after primary script
        setTimeout(function() {
            if (typeof msal === 'undefined') {
                console.warn('MSAL not loaded from primary source, trying fallbacks...');
                sourceIndex = 1; // Skip first source as it already failed
                loadMSALFallback();
            } else {
                console.log('MSAL loaded successfully from primary source');
            }
        }, 1500);
    </script>
    
    <script>
        // Configuration
        const config = {
            auth: {
                clientId: '07d85d3a-2d71-451f-a148-3ab6a12cb2b1',
                authority: 'https://login.microsoftonline.com/30b2cab5-4b41-42ba-9ae3-af22c87241d9',
                redirectUri: window.location.origin + '/',
                navigateToLoginRequestUrl: false
            },
            cache: {
                cacheLocation: 'sessionStorage',
                storeAuthStateInCookie: false
            },
            system: {
                loggerOptions: {
                    loggerCallback: (level, message, containsPii) => {
                        if (containsPii) {
                            return;
                        }
                        switch (level) {
                            case msal.LogLevel.Error:
                                console.error(message);
                                return;
                            case msal.LogLevel.Info:
                                console.info(message);
                                return;
                            case msal.LogLevel.Verbose:
                                console.debug(message);
                                return;
                            case msal.LogLevel.Warning:
                                console.warn(message);
                                return;
                        }
                    },
                    piiLoggingEnabled: false,
                    logLevel: msal.LogLevel.Info
                }
            }
        };

        const environmentId = 'Default-30b2cab5-4b41-42ba-9ae3-af22c87241d9';
        
        // Initialize MSAL
        const msalInstance = new msal.PublicClientApplication(config);
        
        // Application state
        let currentAccount = null;
        let allFlows = [];
        let filteredFlows = [];
        let isInitialized = false;

        // Initialize the application
        async function initializeApp() {
            console.log('Starting app initialization...');
            console.log('Redirect URI:', window.location.origin + '/');
            
            try {
                // Wait for MSAL to initialize
                await msalInstance.initialize();
                isInitialized = true;
                console.log('MSAL initialized successfully');
                
                // Handle redirect response
                try {
                    const response = await msalInstance.handleRedirectPromise();
                    console.log('Redirect response:', response);
                    
                    if (response && response.account) {
                        currentAccount = response.account;
                        console.log('User signed in via redirect:', currentAccount.username);
                        showDashboard();
                        await loadFlows();
                        return;
                    }
                } catch (redirectError) {
                    console.error('Error handling redirect:', redirectError);
                }

                // Check if user is already signed in
                const accounts = msalInstance.getAllAccounts();
                console.log('Found accounts:', accounts.length);
                
                if (accounts.length > 0) {
                    currentAccount = accounts[0];
                    console.log('User already signed in:', currentAccount.username);
                    showDashboard();
                    await loadFlows();
                } else {
                    console.log('No user signed in, showing login screen');
                    showLoginScreen();
                }
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Failed to initialize authentication. Please check console for details.');
                showLoginScreen();
            }
        }

        // Show login screen
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainDashboard').classList.add('hidden');
        }

        // Show dashboard
        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
            
            if (currentAccount) {
                document.getElementById('userEmail').textContent = currentAccount.username;
            }
        }

        // Sign in
        async function signIn() {
            console.log('Sign in button clicked');
            
            // Check if MSAL is initialized
            if (!isInitialized) {
                console.error('MSAL not initialized yet');
                alert('Authentication system is still loading. Please try again in a moment.');
                return;
            }
            
            const loginRequest = {
                scopes: ['https://service.flow.microsoft.com//.default'],
                prompt: 'select_account'
            };

            console.log('Attempting login with request:', loginRequest);
            
            try {
                // Try popup first, fallback to redirect if blocked
                try {
                    console.log('Trying popup login...');
                    const response = await msalInstance.loginPopup(loginRequest);
                    console.log('Popup login successful:', response);
                    
                    if (response.account) {
                        currentAccount = response.account;
                        showDashboard();
                        await loadFlows();
                    }
                } catch (popupError) {
                    console.error('Popup blocked or failed:', popupError);
                    console.log('Falling back to redirect login...');
                    
                    // Fallback to redirect
                    await msalInstance.loginRedirect(loginRequest);
                }
            } catch (error) {
                console.error('Login error:', error);
                
                // Provide more specific error messages
                let errorMessage = 'Failed to sign in. ';
                
                if (error.errorCode === 'popup_window_error') {
                    errorMessage += 'Pop-up blocked. Please allow pop-ups for this site.';
                } else if (error.errorCode === 'user_cancelled') {
                    errorMessage += 'Sign-in was cancelled.';
                } else if (error.errorCode) {
                    errorMessage += `Error code: ${error.errorCode}`;
                } else {
                    errorMessage += 'Please check console for details.';
                }
                
                alert(errorMessage);
                showError(errorMessage);
            }
        }

        // Sign out
        async function signOut() {
            if (!currentAccount) {
                console.log('No account to sign out');
                return;
            }
            
            const logoutRequest = {
                account: currentAccount,
                postLogoutRedirectUri: window.location.origin + '/'
            };

            console.log('Signing out:', currentAccount.username);
            
            try {
                await msalInstance.logoutRedirect(logoutRequest);
            } catch (error) {
                console.error('Logout error:', error);
                // Clear local cache even if logout fails
                sessionStorage.clear();
                location.reload();
            }
        }

        // Get access token
        async function getToken() {
            const tokenRequest = {
                scopes: ['https://service.flow.microsoft.com//.default'],
                account: currentAccount,
                forceRefresh: false
            };

            try {
                console.log('Acquiring token silently...');
                const response = await msalInstance.acquireTokenSilent(tokenRequest);
                console.log('Token acquired successfully');
                return response.accessToken;
            } catch (error) {
                console.error('Silent token acquisition failed:', error);
                
                if (error instanceof msal.InteractionRequiredAuthError) {
                    console.log('Interaction required, attempting interactive token acquisition...');
                    try {
                        // Try popup first
                        const response = await msalInstance.acquireTokenPopup(tokenRequest);
                        console.log('Token acquired via popup');
                        return response.accessToken;
                    } catch (popupError) {
                        console.error('Popup token acquisition failed:', popupError);
                        // Fallback to redirect
                        await msalInstance.acquireTokenRedirect(tokenRequest);
                    }
                } else {
                    console.error('Token acquisition error:', error);
                    throw error;
                }
            }
        }

        // Load flows from API
        async function loadFlows() {
            showLoading(true);
            hideError();

            try {
                const token = await getToken();
                
                const response = await fetch(
                    `https://api.flow.microsoft.com/providers/Microsoft.ProcessSimple/environments/${environmentId}/flows?api-version=2016-11-01`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                allFlows = data.value || [];
                
                applyFilters();
                updateStatistics();
                
            } catch (error) {
                console.error('Error loading flows:', error);
                showError('Failed to load flows. Please check your permissions and try again.');
            } finally {
                showLoading(false);
            }
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            filteredFlows = allFlows.filter(flow => {
                const matchesSearch = !searchTerm || 
                    flow.properties.displayName.toLowerCase().includes(searchTerm) ||
                    flow.name.toLowerCase().includes(searchTerm);

                const matchesStatus = !statusFilter || 
                    flow.properties.state === statusFilter;

                return matchesSearch && matchesStatus;
            });

            renderFlows();
        }

        // Render flows
        function renderFlows() {
            const grid = document.getElementById('flowsGrid');
            grid.innerHTML = '';

            if (filteredFlows.length === 0) {
                grid.innerHTML = '<div class="loading"><p>No flows found matching your criteria.</p></div>';
                return;
            }

            filteredFlows.forEach(flow => {
                const card = createFlowCard(flow);
                grid.appendChild(card);
            });
        }

        // Create flow card
        function createFlowCard(flow) {
            const card = document.createElement('div');
            card.className = 'flow-card';
            
            const state = flow.properties.state || 'Unknown';
            const statusClass = state.toLowerCase();
            
            const createdTime = new Date(flow.properties.createdTime).toLocaleDateString();
            const modifiedTime = new Date(flow.properties.lastModifiedTime).toLocaleDateString();
            
            card.innerHTML = `
                <div class="flow-header">
                    <div>
                        <div class="flow-name">${flow.properties.displayName}</div>
                        <div class="flow-id">${flow.name}</div>
                    </div>
                    <span class="flow-status status-${statusClass}">${state}</span>
                </div>
                <div class="flow-details">
                    <div class="flow-detail">
                        <span class="detail-label">Created</span>
                        <span class="detail-value">${createdTime}</span>
                    </div>
                    <div class="flow-detail">
                        <span class="detail-label">Modified</span>
                        <span class="detail-value">${modifiedTime}</span>
                    </div>
                    <div class="flow-detail">
                        <span class="detail-label">Type</span>
                        <span class="detail-value">${flow.properties.flowTriggerUri ? 'Instant' : 'Automated'}</span>
                    </div>
                    <div class="flow-detail">
                        <span class="detail-label">Environment</span>
                        <span class="detail-value">${flow.properties.environment.name}</span>
                    </div>
                </div>
            `;
            
            card.addEventListener('click', () => {
                window.open(`https://make.powerautomate.com/environments/${environmentId}/flows/${flow.name}/details`, '_blank');
            });
            
            return card;
        }

        // Update statistics
        function updateStatistics() {
            const stats = {
                total: allFlows.length,
                running: allFlows.filter(f => f.properties.state === 'Running').length,
                stopped: allFlows.filter(f => f.properties.state === 'Stopped').length,
                suspended: allFlows.filter(f => f.properties.state === 'Suspended').length
            };

            document.getElementById('totalFlows').textContent = stats.total;
            document.getElementById('runningFlows').textContent = stats.running;
            document.getElementById('stoppedFlows').textContent = stats.stopped;
            document.getElementById('suspendedFlows').textContent = stats.suspended;
        }

        // Show/hide loading state
        function showLoading(show) {
            document.getElementById('loadingState').classList.toggle('hidden', !show);
            document.getElementById('flowsGrid').classList.toggle('hidden', show);
        }

        // Show/hide error
        function showError(message) {
            const errorState = document.getElementById('errorState');
            const errorMessage = document.getElementById('errorMessage');
            
            if (message) {
                errorMessage.textContent = message;
                errorState.classList.remove('hidden');
            } else {
                errorState.classList.add('hidden');
            }
        }

        function hideError() {
            document.getElementById('errorState').classList.add('hidden');
        }

        // Test configuration
        function testConfiguration() {
            const statusDiv = document.getElementById('configStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = '#e7f3ff';
            statusDiv.style.color = '#0078d4';
            
            let statusHTML = '<strong>Configuration Check:</strong><br>';
            statusHTML += `✓ Client ID: ${config.auth.clientId}<br>`;
            statusHTML += `✓ Tenant ID: 30b2cab5-4b41-42ba-9ae3-af22c87241d9<br>`;
            statusHTML += `✓ Current URL: ${window.location.origin}/<br>`;
            statusHTML += `✓ Redirect URI: ${config.auth.redirectUri}<br>`;
            statusHTML += `✓ MSAL Library: ${typeof msal !== 'undefined' ? 'Loaded' : '<span style="color: red;">NOT LOADED</span>'}<br>`;
            statusHTML += `✓ MSAL Initialized: ${isInitialized ? 'Yes' : 'No'}<br>`;
            
            if (typeof msal === 'undefined') {
                statusHTML += `<br><strong style="color: #d83b01;">⚠ Critical Issue:</strong> MSAL library not loaded<br>`;
                statusHTML += `Attempting manual load...<br>`;
                
                // Try to manually load MSAL
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.0/lib/msal-browser.min.js';
                script.onload = function() {
                    statusHTML += '<span style="color: green;">✓ MSAL loaded manually! Refreshing...</span>';
                    statusDiv.innerHTML = statusHTML;
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                };
                script.onerror = function() {
                    statusHTML += '<span style="color: red;">✗ Manual load failed. Check network/firewall.</span>';
                    statusDiv.innerHTML = statusHTML;
                };
                document.head.appendChild(script);
            }
            
            if (window.location.origin + '/' !== 'https://white-stone-0a0c84010.1.azurestaticapps.net/') {
                statusHTML += `<br><strong style="color: #d83b01;">⚠ Warning:</strong> Current URL doesn't match expected redirect URI<br>`;
                statusHTML += `Expected: https://white-stone-0a0c84010.1.azurestaticapps.net/<br>`;
                statusHTML += `Please ensure this URL is added to your Azure App Registration`;
            }
            
            statusDiv.innerHTML = statusHTML;
            
            // Make functions available globally for debugging
            window.debugAuth = {
                msalInstance: msalInstance,
                config: config,
                signIn: signIn,
                initializeApp: initializeApp,
                currentAccount: currentAccount
            };
            
            console.log('Debug functions available at window.debugAuth');
        }

        // Event listeners
        document.getElementById('loginButton').addEventListener('click', signIn);
        document.getElementById('testConfigButton').addEventListener('click', testConfiguration);
        document.getElementById('logoutButton').addEventListener('click', signOut);
        document.getElementById('refreshButton').addEventListener('click', loadFlows);
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);

        // Initialize app on load
        window.addEventListener('load', () => {
            console.log('Page loaded, checking for MSAL...');
            
            let attempts = 0;
            const maxAttempts = 10;
            
            const checkMSAL = setInterval(() => {
                attempts++;
                
                if (typeof msal !== 'undefined') {
                    console.log('MSAL library detected, initializing app...');
                    clearInterval(checkMSAL);
                    initializeApp();
                } else if (attempts >= maxAttempts) {
                    console.error('MSAL library failed to load after ' + maxAttempts + ' attempts');
                    clearInterval(checkMSAL);
                    
                    const statusDiv = document.getElementById('configStatus');
                    if (statusDiv) {
                        statusDiv.style.display = 'block';
                        statusDiv.style.backgroundColor = '#fde7e9';
                        statusDiv.style.color = '#d83b01';
                        statusDiv.innerHTML = '<strong>Error:</strong> Authentication library failed to load.<br>' +
                                            'This could be due to:<br>' +
                                            '• Network/firewall blocking Microsoft CDN<br>' +
                                            '• Browser extensions blocking scripts<br>' +
                                            '• Corporate proxy settings<br><br>' +
                                            'Try: Disabling ad blockers, using a different browser, or checking network settings.';
                    }
                } else {
                    console.log('Waiting for MSAL... attempt ' + attempts + '/' + maxAttempts);
                }
            }, 500);
        });
    </script>
</body>
</html>
